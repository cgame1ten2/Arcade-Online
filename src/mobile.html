<!-- mobile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcade Controller</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- Include p5 for the Avatar preview on phone -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #2c3e50; font-family: sans-serif; overflow: hidden; touch-action: none; color: white; }
        
        /* SCREENS */
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* CONNECT SCREEN */
        input { font-size: 24px; padding: 10px; text-align: center; text-transform: uppercase; margin-bottom: 20px; border-radius: 8px; border: none; }
        button { font-size: 20px; padding: 15px 30px; background: #2ecc71; border: none; color: white; border-radius: 8px; font-weight: bold; }

        /* LOBBY SCREEN */
        .avatar-preview { width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; margin-bottom: 20px; }
        .control-row { margin: 10px 0; display: flex; gap: 10px; width: 80%; }
        .control-row button { flex: 1; font-size: 16px; padding: 10px; }
        input[type=range] { width: 100%; margin: 20px 0; }

        /* ONE BUTTON CONTROLLER */
        #btn-big { width: 90vw; height: 70vh; border-radius: 20px; border: 8px solid rgba(0,0,0,0.2); font-size: 40px; text-shadow: 2px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; flex-direction: column; transition: transform 0.1s; }
        #btn-big:active { transform: scale(0.98); }
        
        /* TOUCHPAD */
        #touch-surface { width: 100vw; height: 100vh; background: #34495e; position: relative; }
        #touch-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="screen-login" class="screen active">
        <h1>Wonder Arcade</h1>
        <p>Enter Room Code found on TV:</p>
        <input type="text" id="room-code" placeholder="ABCD" maxlength="4">
        <button onclick="connect()">JOIN GAME</button>
        <p id="status" style="margin-top: 20px; color: #f1c40f;"></p>
    </div>

    <!-- 2. LOBBY EDITOR -->
    <div id="screen-lobby" class="screen">
        <div id="lobby-avatar" class="avatar-preview"></div>
        <input type="text" id="p-name" placeholder="Name" oninput="sendUpdate()">
        <input type="range" id="p-color" min="0" max="360" oninput="updateColor(this.value)">
        <div class="control-row">
            <button onclick="changeAccessory()">Accessory</button>
            <button onclick="toggleVariant()">Boy/Girl</button>
        </div>
        <div style="margin-top: 20px; opacity: 0.6;">Check TV for Preview</div>
    </div>

    <!-- 3. ARCADE BUTTON -->
    <div id="screen-controller" class="screen">
        <div id="btn-big">
            <div id="btn-avatar" style="width: 120px; height: 120px;"></div>
            <span>TAP!</span>
        </div>
    </div>

    <!-- 4. TOUCHPAD -->
    <div id="screen-touchpad" class="screen">
        <div id="touch-surface">
            <div id="touch-msg">Swipe to Move<br>Tap to Click</div>
        </div>
    </div>

    <script src="./src/core/AvatarSystem.js" type="module"></script>
    <script type="module">
        import AvatarSystem from './src/core/AvatarSystem.js';

        // State
        let peer, conn;
        let player = { id: -1, color: '#333', name: 'Guest', accessory: 'Bear Ears', variant: 'default' };
        let p5Lobby, p5Btn;

        window.connect = () => {
            const code = document.getElementById('room-code').value.toUpperCase();
            if(code.length < 4) return;

            document.getElementById('status').innerText = "Connecting...";
            
            peer = new Peer();
            peer.on('open', (id) => {
                conn = peer.connect(`wonder-${code}`);
                
                conn.on('open', () => {
                    document.getElementById('status').innerText = "Connected! Waiting for Host...";
                });

                conn.on('data', (data) => handleData(data));
                
                conn.on('close', () => {
                    alert("Disconnected from Host");
                    location.reload();
                });
            });
        };

        function handleData(data) {
            if(data.type === 'INIT') {
                player = { ...player, ...data }; // Merge IDs
                showScreen('screen-lobby'); // Default to lobby initially
                initP5();
            }
            else if (data.type === 'PING') {
                conn.send({ type: 'PONG', ts: data.ts });
            }
            else if (data.type === 'STATE_CHANGE') {
                // Host changed game mode, switch UI
                if (data.state === 'LOBBY') showScreen('screen-lobby');
                else if (data.state === 'CONTROLLER') {
                    showScreen('screen-controller');
                    updateControllerVisuals();
                }
                else if (data.state === 'TOUCHPAD') showScreen('screen-touchpad');
            }
        }

        // --- CONTROLLER LOGIC ---
        const btn = document.getElementById('btn-big');
        
        const sendPress = (e) => { e.preventDefault(); conn.send({ type: 'INPUT', action: 'PRESS' }); btn.style.transform = "scale(0.95)"; };
        const sendRelease = (e) => { e.preventDefault(); conn.send({ type: 'INPUT', action: 'RELEASE' }); btn.style.transform = "scale(1)"; };

        btn.addEventListener('touchstart', sendPress);
        btn.addEventListener('touchend', sendRelease);
        btn.addEventListener('mousedown', sendPress);
        btn.addEventListener('mouseup', sendRelease);

        // --- LOBBY LOGIC ---
        window.sendUpdate = () => {
            const name = document.getElementById('p-name').value;
            player.name = name;
            conn.send({ type: 'UPDATE_PROFILE', payload: { name: name } });
        };

        window.updateColor = (hue) => {
            const color = `hsl(${hue}, 70%, 50%)`; // Simplified logic, ideally match host Hex conversion
            // Just sending hue for now or convert to Hex if needed
            // For prototype, let's assume Host accepts updates
            // (Requires HSL->Hex util here to match perfectly)
        }
        
        // --- SCREEN MANAGER ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initP5() {
            // Instantiate p5 for lobby avatar preview
             const sketch = (p) => {
                let sys;
                p.setup = () => { p.createCanvas(200, 200); sys = new AvatarSystem(p); };
                p.draw = () => {
                    p.clear(); p.translate(100, 100);
                    sys.draw({ x:0, y:0, size:180, color: player.color, variant: player.variant, accessory: player.accessory });
                };
            };
            p5Lobby = new p5(sketch, 'lobby-avatar');
        }
        
        function updateControllerVisuals() {
            btn.style.backgroundColor = player.color;
            btn.style.borderColor = shadeColor(player.color, -20);
            // Render small avatar on button...
        }
        
        // Helper
        function shadeColor(color, percent) { /* ... same as AvatarSystem ... */ return color; }

    </script>
</body>
</html>
